<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:Ifpa.Converters"
             x:Class="Ifpa.Views.RankingsPage"
             Title="{Binding Title}"
             xmlns:fluent="clr-namespace:MauiIcons.Fluent;assembly=MauiIcons.Fluent"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Name="BrowseItemsPage">
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Filter" x:Name="SearchButton" Clicked="SearchButton_Clicked" IconImageSource="{fluent:Icon Icon=Search48, IconColor={StaticResource IconAccentColor}}" />
        <ToolbarItem Text="Filter" x:Name="InfoButton" Clicked="InfoButton_Clicked" IconImageSource="{fluent:Icon Icon=Filter28, IconColor={StaticResource IconAccentColor}}" />
    </ContentPage.ToolbarItems>
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:IntToOrdinalStringConverter x:Key="intToOrdinalString" />
            <toolkit:InvertedBoolConverter x:Key="invertedBoolConverter" />
            <toolkit:IsStringNullOrEmptyConverter x:Key="nullOrEmptyConverter" />
            <toolkit:MultiConverter x:Key="invertedNullOrEmptyConverter">
                <toolkit:IsStringNullOrEmptyConverter />
                <toolkit:InvertedBoolConverter />
            </toolkit:MultiConverter>            
        </ResourceDictionary>
    </ContentPage.Resources>
    <Grid>
        <ActivityIndicator IsVisible="{Binding IsBusy}" IsRunning="{Binding IsBusy}" />
        <CollectionView x:Name="PlayersListView" 
                 ItemsSource="{Binding Players}"
                 IsVisible="{Binding IsBusy, Converter={StaticResource invertedBoolConverter}}"  
                 SelectionMode="Single"
                 SelectionChanged="PlayersListView_SelectionChanged">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <StackLayout>
                        <Grid ColumnDefinitions="Auto,*,60" RowDefinitions="*,*" Margin="0,5">
                            <Label Grid.Column="0" Grid.RowSpan="2" Margin="10,5" VerticalTextAlignment="Center" 
                               Text="{Binding CurrentRank, Converter={StaticResource intToOrdinalString}}" 
                                   LineBreakMode="NoWrap"                                     
                                   FontSize="24" MinimumWidthRequest="58" />

                            <Label LineBreakMode="NoWrap" FontSize="16" Grid.Column="1" Grid.Row="0">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <FormattedString.Spans>
                                            <Span Text="{Binding FirstName}" />
                                            <Span Text=" " />
                                            <Span Text="{Binding LastName}" />
                                        </FormattedString.Spans>
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            <StackLayout Orientation="Horizontal" Grid.Row="1" 
                                         Grid.Column="1">
                                <!-- City -->
                                <Label TextColor="{DynamicResource SecondaryTextColor}" Text="{Binding City}" LineBreakMode="NoWrap" FontSize="12" VerticalTextAlignment="Center"
                                       IsVisible="{Binding City, Converter={StaticResource invertedNullOrEmptyConverter}}"
                                       Padding="0,0,5,0"/>
                                <!-- , State -->
                                <Label TextColor="{DynamicResource SecondaryTextColor}" Text="," LineBreakMode="NoWrap" FontSize="12" VerticalTextAlignment="Center" 
                                       IsVisible="{Binding StateProvince, Converter={StaticResource invertedNullOrEmptyConverter}}" Margin="-5,0,0,0" Padding="0,0,5,0" />
                                <Label TextColor="{DynamicResource SecondaryTextColor}" Text="{Binding StateProvince}" LineBreakMode="NoWrap" FontSize="12" VerticalTextAlignment="Center" 
                                       IsVisible="{Binding StateProvince, Converter={StaticResource invertedNullOrEmptyConverter}}" Padding="0,0,5,0" />
                                <!-- Country -->
                                <Label TextColor="{DynamicResource SecondaryTextColor}" Text="{Binding CountryName}" LineBreakMode="NoWrap" FontSize="12" VerticalTextAlignment="Center" />
                            </StackLayout>
                           
                            <Label Grid.Column="2" Grid.Row="1" TextColor="{DynamicResource SecondaryTextColor}" Margin="10,0" HorizontalTextAlignment="End" 
                               Text="{Binding WpprPoints, StringFormat='{0:N2}'}" LineBreakMode="NoWrap"  VerticalTextAlignment="Center" FontSize="10" />

                            <Label Grid.Column="1" Grid.ColumnSpan="2" Grid.Row="0" LineBreakMode="NoWrap" TextColor="{DynamicResource SecondaryTextColor}"
                               Margin="10,0" FontSize="10" HorizontalTextAlignment="End" VerticalTextAlignment="Center" 
                               IsVisible="{Binding Source={x:Reference BrowseItemsPage}, Path=BindingContext.ShowOverallRank}">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <FormattedString.Spans>
                                            <Span Text="Overall Rank:" />
                                            <Span Text=" " />
                                            <Span Text="{Binding CurrentWpprRank, Converter={StaticResource intToOrdinalString}}" />
                                        </FormattedString.Spans>
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </Grid>

                        <BoxView Style="{StaticResource BoxSeperator}"/>
                    </StackLayout>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>